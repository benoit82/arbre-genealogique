name: Configure Optional E2E Protection

on:
  pull_request:
    branches: [ main ]

jobs:
  check-e2e-results:
    name: Check E2E Results
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Wait for E2E tests to complete
        uses: lewagon/wait-for-check@v1
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          check-name: 'E2E Tests'
          timeout-seconds: 300
          check-interval-seconds: 10

      - name: Analyze E2E results
        run: |
          echo "Analyzing E2E test results..."
          
          # Get the check conclusion
          CONCLUSION=$(gh api repos/${{ github.repository }}/commits/${{ github.event.pull_request.head.sha }}/check-runs \
            --jq='.check_runs[] | select(.name=="E2E Tests") | .conclusion' \
            --jq='first')
          
          echo "E2E conclusion: $CONCLUSION"
          
          # Update PR status
          if [[ "$CONCLUSION" == "success" ]]; then
            echo "✅ E2E Tests Passed"
            echo "::notice::E2E tests passed - core validations can proceed::"
          elif [[ "$CONCLUSION" == "failure" ]]; then
            echo "❌ E2E Tests Failed - but allowing merge for now"
            echo "::warning::E2E tests failed - review recommended::"
          elif [[ "$CONCLUSION" == "neutral" || "$CONCLUSION" == "cancelled" ]]; then
            echo "⚠️ E2E Tests $CONCLUSION - allowing merge for now"
            echo "::warning::E2E tests $CONCLUSION - allowing merge but review recommended::"
          else
            echo "❓ E2E Tests $CONCLUSION"
            echo "::warning::E2E tests inconclusive - manual review required::"
          fi

  set-pr-status:
    name: Set PR Status Based on E2E Results
    runs-on: ubuntu-latest
    needs: check-e2e-results
    if: github.event_name == 'pull_request'
    steps:
      - name: Update PR Status
        run: |
          echo "E2E tests check completed - PR can proceed"